## Servidor Distrital {#sec:district}

O servidor distrital é o servidor responsável por fazer toda a lógica de cada um dos distritos de modo a responder ao clientes, que fazem os seus pedidos através do servidor de _frontend_.

O servidor distrital está organizado de modo a ter 3 _threads_ a correr em simultâneo, a _thread_ responsável por atender de facto os pedidos dos clientes e enviar as repostas ao servidor de _frontend_ de forma a que este encaminhe a reposta de volta para cliente, utilizando para isso um processo de _parsing_ da mensagem de forma a saber qual das suas operações tem de executar, uma outra thread responsável por enviar as notificações públicas aos vários clientes que decidam estar ligados ao serviço de notificações públicas do servidor, e por fim uma thread para notificações privadas que vão enviando as notificações de contacto para cada utilizador presente no distrito que tenha estado em contacto com um outro utilizador que se tenha dado como infectado.

Para manter o contacto entre a _thread_ que dá as respostas e as restantes utilizamos um sistema de _sockets_ comum, tendo assim uma socket que liga a componente principal às notificações públicas e as privadas, ficando cada uma destas depois responsável por encaminhar as mensagem para os seus _subscribers_, estas _threads_ de notificações fora feitas utilizando o _ZeroMQ_ e as suas sockets _SUB_ e _PUB_ sendo que as _SUB_ são utilizadas nos clientes e por isso melhor explicadas mais à frente.

Para conseguir responder aos vários pedidos que os clientes podem fazer os distritos guardam várias variáveis, como um mapa que permite saber para uma dada localização dentro do distrito quais são os utilizadores que lá estão, sendo que também possui um mapa que associa os nomes do utilizadores aos próprios para facilitar a gestão. Cada um dos utilizadores presentes no distrito está representado como sendo um objeto da classe _User_ que vai guardando consigo os vários contactos particulares de cada um dos utilizadores, sendo que estes contactos vão sendo atualizados sempre que um utilizador pretende mudar de local dentro do distrito, garantindo que os utilizadores que estão na nova localização do utilizador que mudou saibam que estão em contacto com um novo utilizador e por isso é adicionado à sua lista de contactos.

Através da lista de contactos de cada um dos utilizadores podemos notificar de forma particular cada um dos clientes que tenha estado em contacto com um utilizador que mais tarde se tenha dado como infetado de uma forma muito simples, permitindo também manter a informação do diretório atualizada através do tamanho desta lista de contactos e das localizações dos utilizadores.

Para que seja possível um cliente subscrever as notificações de um distrito foi então criada uma thread _Publisher_ para notificações públicas, e a porta na qual estes _Publishers_ vão publicar a sua informação está bem explícita num ficheiro de configuração, quando há o pedido de um cliente para subscrever a um distrito é pedido ao servidor distrital através do _frontend_ a porta em que as publica, e de seguida reencaminhada para o cliente que com ela pode ligar-se de forma direta ao _Publisher_ e subscrever os _canais_ que mais lhe interessarem, já as notificações privadas, o utilizador logo a partir do momento em que faz o _login_ através do _frontend_ faz uma ligação para o _Publisher_ de notificações privadas do distrito utilizando o seu próprio nome para mais tarde ser mais fácil de notificar em caso de infecção de um dos seus contactos.
